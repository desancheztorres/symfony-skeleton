# Docker Compose configuration for PRODUCTION environment
# Optimized for security, performance and monitoring
version: "3.9"

services:
  php:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
      args:
        PUID: ${PUID:-1000}
        PGID: ${PGID:-1000}
    container_name: ${COMPOSE_PROJECT_NAME:-symfony-skeleton}-php-prod
    restart: always
    environment:
      APP_ENV: prod
      DATABASE_URL: mysql://${DB_USER}:${DB_PASSWORD}@db:3306/${DB_NAME}?serverVersion=mariadb-11.4&charset=utf8mb4
    depends_on:
      - db
    # No volumes mounted - code is baked into the image

  nginx:
    image: nginx:alpine
    container_name: ${COMPOSE_PROJECT_NAME:-symfony-skeleton}-nginx-prod
    restart: always
    depends_on:
      - php
    ports:
      - "${NGINX_PORT:-80}:80"
      - "${NGINX_SSL_PORT:-443}:443"
    volumes:
      - ./docker/nginx/prod.conf:/etc/nginx/conf.d/default.conf:ro
      - ./docker/ssl:/etc/nginx/ssl:ro

  db:
    image: mariadb:11.4
    container_name: ${COMPOSE_PROJECT_NAME:-symfony-skeleton}-mariadb-prod
    restart: always
    environment:
      MARIADB_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
      MARIADB_DATABASE: ${DB_NAME}
      MARIADB_USER: ${DB_USER}
      MARIADB_PASSWORD: ${DB_PASSWORD}
    volumes:
      - db-data-prod:/var/lib/mysql
      - ./docker/mysql/prod.cnf:/etc/mysql/conf.d/custom.cnf:ro

volumes:
  db-data-prod: